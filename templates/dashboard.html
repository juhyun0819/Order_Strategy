<!DOCTYPE html>
<html lang="ko" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì—¬ì„±ë³µ ì˜ë¥˜ ë„ë§¤ - ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='output.css') }}"
      rel="stylesheet"
    />
    <style>
      .th-sort {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        cursor: pointer;
        user-select: none;
      }
      .sort-arrows {
        display: inline-flex;
        flex-direction: column;
        margin-left: 2px;
        font-size: 12px;
        line-height: 1;
      }
      .sort-arrow {
        color: #cbd5e1;
        transition: color 0.2s, transform 0.15s;
        cursor: pointer;
        height: 16px;
        display: block;
      }
      .sort-arrow:hover {
        color: #2563eb;
        transform: scale(1.25) translateY(-1px);
      }
      .sort-arrow.active {
        color: #2563eb;
        font-weight: bold;
        transform: scale(1.25);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg">
      <div class="flex h-16 items-center border-b px-6">
        <div class="flex items-center space-x-2">
          <div
            class="h-8 w-8 rounded-lg bg-blue-600 flex items-center justify-center"
          >
            <i class="fas fa-tshirt text-white text-sm"></i>
          </div>
          <span class="text-lg font-semibold">ì˜ë¥˜ ë„ë§¤</span>
        </div>
      </div>
      <nav class="flex-1 space-y-1 px-3 py-4">
        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <a
          href="/dashboard"
          class="flex items-center space-x-3 rounded-lg px-3 py-2 text-gray-700 transition-colors {% if not selected_product %} bg-gray-100 font-bold {% else %} hover:bg-gray-100 {% endif %}"
        >
          <i class="fas fa-chart-line text-gray-500"></i>
          <span>ëŒ€ì‹œë³´ë“œ</span>
        </a>
        <a
          href="/reset-db"
          onclick="return confirm('ì •ë§ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
          class="flex items-center space-x-3 rounded-lg px-3 py-2 text-gray-700 hover:bg-gray-100 transition-colors"
        >
          <i class="fas fa-trash text-gray-500"></i>
          <span>DB ì´ˆê¸°í™”</span>
        </a>
        {% if sidebar_products %}
        <div
          class="mt-6 overflow-y-auto"
          style="max-height: calc(100vh - 180px)"
        >
          <div class="text-xs text-gray-400 font-semibold mb-2 pl-2">
            íŒŒë ˆí†  ìƒí’ˆ
          </div>
          <ul class="space-y-1">
            {% for product in sidebar_products %}
            <li>
              <a
                href="/dashboard?product={{ product }}"
                class="block px-3 py-2 rounded-lg transition-colors truncate {% if selected_product == product %} bg-blue-100 text-blue-700 font-bold {% else %} text-gray-700 hover:bg-blue-50 hover:text-blue-700 {% endif %}"
                title="{{ product }}"
              >
                <i class="fas fa-tshirt text-gray-400 mr-2"></i>{{ product }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </nav>
    </div>

    <!-- Main content -->
    <div class="pl-64">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="flex h-16 items-center justify-between px-6">
          <div>
            <h1 class="text-2xl font-semibold text-gray-900">Dashboard</h1>
            <p class="text-sm text-gray-500">ì—¬ì„±ë³µ ì˜ë¥˜ ë„ë§¤ í˜„í™©</p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div class="h-2 w-2 rounded-full bg-green-500"></div>
              <span class="text-sm text-gray-500">ì‹œìŠ¤í…œ ì •ìƒ</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Page content -->
      <main class="p-6">
        {% if selected_product %}
        <!-- ìƒí’ˆë³„ ìƒì„¸ ì •ë³´ í™”ë©´ -->
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-tshirt text-blue-600"></i>
              </div>
              <div class="flex-1 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900 inline-block">
                  {{ selected_product }}
                </h2>
                <!-- ì£¼ì°¨ë³„ ê±°ë˜ì²˜ ìˆ˜ ì…ë ¥ë€ -->
                <form
                  method="post"
                  class="flex items-center"
                >
                  <input type="hidden" name="weekly_client_count_form" value="1" />
                  <input
                    type="number"
                    min="0"
                    name="weekly_client_count"
                    class="form-control w-32 mr-2"
                    placeholder="ì£¼ì°¨ë³„ ê±°ë˜ì²˜"
                    value="{{ current_week_client_count if current_week_client_count is not none else '' }}"
                  />
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-save"></i>
                  </button>
                </form>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div class="bg-gray-50 rounded-lg p-4 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">ëˆ„ì  íŒë§¤ëŸ‰</div>
                <div class="text-2xl font-bold text-blue-700">
                  {{ stats.product_total_sales }}
                </div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">í˜„ì¬ê³ </div>
                <div class="text-2xl font-bold text-green-700">
                  {{ stats.product_current_stock }}
                </div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">ìµœê·¼ 7ì¼ íŒë§¤ëŸ‰</div>
                <div class="text-2xl font-bold text-pink-700">
                  {{ stats.product_7days_sales }}
                </div>
              </div>
            </div>
            <!-- ë¹„êµ ìƒí’ˆ ì—…ë¡œë“œ UI -->
            <form
              method="post"
              enctype="multipart/form-data"
              class="mb-6 flex items-center gap-4"
              style="background: #f8fafc; border-radius: 0.5rem; padding: 1rem"
            >
              <label
                for="compare_file"
                class="text-sm font-semibold text-gray-700"
                >ë¹„êµ ìƒí’ˆ ì—‘ì…€ ì—…ë¡œë“œ</label
              >
              <input
                type="file"
                name="compare_file"
                id="compare_file"
                accept=".xls,.xlsx"
                class="form-control"
                required
              />
              <button
                type="submit"
                name="compare_upload"
                value="1"
                class="btn btn-primary px-4"
              >
                ì—…ë¡œë“œ
              </button>
            </form>
            {% if plots.sales_trend %}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                íŒë§¤ ì¶”ì„¸
              </h3>
              <div
                id="echart-product-sales-trend"
                style="width: 100%; height: 300px"
              ></div>
            </div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                  var option_product_sales_trend = {{ plots.sales_trend.config|tojson }};
                  option_product_sales_trend.tooltip = {trigger: 'axis'};

                  var chartDomProduct = document.getElementById('echart-product-sales-trend');
                  if (chartDomProduct) {
                      var myChartProduct = echarts.init(chartDomProduct);
                      myChartProduct.setOption(option_product_sales_trend);
                  }
              });
            </script>
            {% endif %}             {% if plots.weekly_sales_trend %}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">ì£¼ë³„ íŒë§¤ëŸ‰</h3>
              <div
                id="echart-product-weekly-sales-trend"
                style="width: 100%; height: 300px"
              ></div>
            </div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                  var option_weekly_sales_trend = {{ plots.weekly_sales_trend.config|tojson }};
                  option_weekly_sales_trend.title = undefined;
                  option_weekly_sales_trend.tooltip = {
                      trigger: 'axis',
                      axisPointer: {
                          type: 'cross',
                          label: {
                              backgroundColor: '#6a7985'
                          }
                      },
                      formatter: function(params) {
                          var result = params[0].axisValue + '<br/>';
                          params.forEach(function(param) {
                              if (param.value !== null && param.value !== undefined) {
                                  result += param.marker + param.seriesName + ': ' + param.value + '<br/>';
                              }
                          });
                          return result;
                      }
                  };

                  var chartDomWeekly = document.getElementById('echart-product-weekly-sales-trend');
                  if (chartDomWeekly) {
                      var myChartWeekly = echarts.init(chartDomWeekly);
                      myChartWeekly.setOption(option_weekly_sales_trend);
                  }
              });
            </script>
            {% endif %}
          </div>
        </div>
        {% else %}
        <!-- ê¸°ì¡´ ì „ì²´ ëŒ€ì‹œë³´ë“œ -->
        <!-- Upload Section -->
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-upload text-blue-600"></i>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-gray-900">
                  ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
                </h2>
                <p class="text-sm text-gray-500">
                  ì—¬ëŸ¬ ê°œì˜ ì—‘ì…€ íŒŒì¼ì„ í•œ ë²ˆì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </p>
              </div>
            </div>

            <div class="space-y-4 mb-6">
              <div class="flex items-start space-x-2 text-sm text-gray-600">
                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                <span
                  >íŒŒì¼ëª…ì— ë‚ ì§œ(ì˜ˆ: 25.06.29.xlsx)ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ
                  íŒë§¤ì¼ìë¡œ ì¸ì‹ë©ë‹ˆë‹¤</span
                >
              </div>
              <div class="flex items-start space-x-2 text-sm text-gray-600">
                <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                <span
                  >í•„ìˆ˜ ì»¬ëŸ¼:
                  <strong
                    >í’ˆëª…, ì¹¼ë¼, ì‚¬ì´ì¦ˆ, ì‹¤íŒë§¤, í˜„ì¬ê³ , ë¯¸ì†¡ì”ëŸ‰</strong
                  ></span
                >
              </div>
            </div>

            <form
              method="POST"
              enctype="multipart/form-data"
              class="flex gap-4"
            >
              <div class="flex-1">
                <input
                  type="file"
                  name="files"
                  class="form-control"
                  multiple
                  accept=".xls,.xlsx"
                />
              </div>
              <button type="submit" class="btn btn-primary px-8">
                <i class="fas fa-upload mr-2"></i>ì—…ë¡œë“œ
              </button>
            </form>
          </div>
        </div>

        <!-- Date Delete Section -->
        {% if stats.sales_dates > 0 %}
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-red-100 flex items-center justify-center"
              >
                <i class="fas fa-calendar-times text-red-600"></i>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-gray-900">
                  ë‚ ì§œë³„ ë°ì´í„° ì‚­ì œ
                </h2>
                <p class="text-sm text-gray-500">
                  íŠ¹ì • ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </p>
              </div>
            </div>

            <form method="post" action="/delete-date" class="flex gap-4">
              <div class="flex-1">
                <label for="date" class="form-label">ì‚­ì œí•  ë‚ ì§œ ì„ íƒ</label>
                <select name="date" id="date" class="form-control" required>
                  <option value="">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                  {% for date in unique_dates %}
                  <option value="{{ date }}">{{ date }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex items-end">
                <button
                  type="submit"
                  class="btn btn-danger px-8"
                  onclick="return confirm('ì •ë§ë¡œ ì´ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
                >
                  <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                </button>
              </div>
            </form>
          </div>
        </div>
        {% endif %}

        <!-- Alert Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %}
        <div class="mb-8">
          {% for category, message in messages %}
          <div
            class="alert alert-{{ 'danger' if category == 'error' else category }} mb-4"
          >
            {{ message }}
            <button
              type="button"
              class="float-right text-lg font-bold leading-none text-current opacity-50 hover:opacity-75"
              onclick="this.parentElement.remove()"
            >
              <span class="sr-only">Close</span>
              Ã—
            </button>
          </div>
          {% endfor %}
        </div>
        {% endif %} {% endwith %}

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">ì´ ë°ì´í„° ìˆ˜</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ "{:,}".format(stats.total_items) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-boxes text-blue-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">ì´ íŒë§¤ëŸ‰</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ "{:,}".format(stats.total_sales) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-green-100 flex items-center justify-center"
              >
                <i class="fas fa-chart-line text-green-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">ìµœê·¼ 7ì¼ íŒë§¤ëŸ‰</p>
                <p class="text-2xl font-bold text-pink-700">
                  {{ "{:,}".format(stats.recent_7days_sales) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-pink-100 flex items-center justify-center"
              >
                <i class="fas fa-calendar-week text-pink-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">ì´ ë¯¸ì†¡ì”ëŸ‰</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ "{:,}".format(stats.total_pending) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-purple-100 flex items-center justify-center"
              >
                <i class="fas fa-truck text-purple-600"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- ì•Œë¦¼/íŒŒë ˆí† /ìƒí’ˆë³„ ê·¸ë˜í”„/íŒŒë ˆí†  ë¶„ì„ ë“± ì „ì²´ ìƒí’ˆìš© ì„¹ì…˜ -->
        {% if alert_df is not none and not alert_df.empty %}
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-6 border-b">
              <div class="flex items-center space-x-3">
                <div
                  class="h-10 w-10 rounded-lg bg-red-100 flex items-center justify-center"
                >
                  <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900">
                    ì¬ê³  ì˜ˆì¸¡/ë°œì£¼ ì•Œë¦¼
                  </h2>
                  <p class="text-sm text-gray-500">
                    ì¬ê³  ë¶€ì¡± ìœ„í—˜ ìƒí’ˆë“¤ì„ í™•ì¸í•˜ì„¸ìš”
                  </p>
                </div>
              </div>
            </div>
            <div class="overflow-x-auto max-h-96 overflow-y-auto">
              <table class="table" id="alertTable">
                <thead>
                  <tr>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="date"
                    >
                      <span class="flex items-center justify-start">
                        ë‚ ì§œ
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="product"
                    >
                      <span class="flex items-center justify-start">
                        ìƒí’ˆëª…
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="trend"
                    >
                      <span class="flex items-center justify-start">
                        ìµœê·¼ íŒë§¤ ê²½í–¥
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="baseline"
                    >
                      <span class="flex items-center justify-start">
                        ì¤‘ê°„ì„ 
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="current"
                    >
                      <span class="flex items-center justify-center">
                        í˜„ì¬ê³ 
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="shortage"
                    >
                      <span class="flex items-center justify-center">
                        ë¶€ì¡±ìˆ˜ëŸ‰
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="order"
                    >
                      <span class="flex items-center justify-start">
                        ë°œì£¼ì œì•ˆ
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="depletion"
                    >
                      <span class="flex items-center justify-start">
                        ì†Œì§„ì˜ˆìƒì¼
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="alert"
                    >
                      <span class="flex items-center justify-start">
                        ê²½ê³ ë“±ê¸‰
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for _, row in alert_df.iterrows() %}
                  <tr>
                    <td data-sort-value="{{ row['ë‚ ì§œ'] }}" data-sort="date">
                      {{ row['ë‚ ì§œ'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['ìƒí’ˆëª…'] }}"
                      data-sort="product"
                    >
                      {{ row['ìƒí’ˆëª…'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['ìµœê·¼ íŒë§¤ ê²½í–¥'] }}"
                      data-sort="trend"
                    >
                      {% if row['ìµœê·¼ íŒë§¤ ê²½í–¥'] == 'ì¦ê°€' %}
                      <span class="badge badge-primary">ì¦ê°€</span>
                      {% elif row['ìµœê·¼ íŒë§¤ ê²½í–¥'] == 'ê°ì†Œ' %}
                      <span class="badge badge-destructive">ê°ì†Œ</span>
                      {% else %}
                      <span class="badge badge-secondary">ìœ ì§€</span>
                      {% endif %}
                    </td>
                    <td
                      data-sort-value="{{ row['ì¤‘ê°„ì„ '] }}"
                      data-sort="baseline"
                    >
                      {{ row['ì¤‘ê°„ì„ '] }}
                    </td>
                    <td
                      data-sort-value="{{ row['í˜„ì¬ê³ '] }}"
                      data-sort="current"
                    >
                      {{ row['í˜„ì¬ê³ '] }}
                    </td>
                    <td
                      data-sort-value="{{ row['ë¶€ì¡±ìˆ˜ëŸ‰'] }}"
                      data-sort="shortage"
                    >
                      {% if row['ë¶€ì¡±ìˆ˜ëŸ‰'] > 0 %}
                      <span class="badge badge-destructive"
                        >{{ row['ë¶€ì¡±ìˆ˜ëŸ‰'] }}</span
                      >
                      {% else %}
                      <span class="badge badge-primary">0</span>
                      {% endif %}
                    </td>
                    {%- set order_value = 9999 -%} {%- if row['ë°œì£¼ì œì•ˆ'] is
                    string and 'ë°œì£¼ í•„ìš”' in row['ë°œì£¼ì œì•ˆ'] -%} {%- set
                    order_value = row['ë°œì£¼ì œì•ˆ'].split('ê°œ')[0]|int -%} {%-
                    elif row['ë°œì£¼ì œì•ˆ'] == 'ì¶©ë¶„' -%} {%- set order_value = 0
                    -%} {%- endif -%}
                    <td data-sort-value="{{ order_value }}" data-sort="order">
                      {{ row['ë°œì£¼ì œì•ˆ'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['ì†Œì§„ì˜ˆìƒì¼'] }}"
                      data-sort="depletion"
                    >
                      {{ row['ì†Œì§„ì˜ˆìƒì¼'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['ê²½ê³ ë“±ê¸‰'] }}"
                      data-sort="alert"
                    >
                      {% if row['ê²½ê³ ë“±ê¸‰'] == 'ìœ„í—˜' %}
                      <span class="badge badge-destructive">ìœ„í—˜</span>
                      {% elif row['ê²½ê³ ë“±ê¸‰'] == 'ì£¼ì˜' %}
                      <span class="badge badge-secondary">ì£¼ì˜</span>
                      {% else %}
                      <span class="badge badge-primary">ì•ˆì •</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {% if charts.sales_trend %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-chart-line text-blue-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">íŒë§¤ ì¶”ì„¸</h3>
                <p class="text-sm text-gray-500">ì¼ë³„ íŒë§¤ëŸ‰ ì¶”ì´</p>
              </div>
            </div>
            <div
              id="echart-sales-trend"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %} {# ì£¼ë³„ íŒë§¤ì¶”ì„¸ ê·¸ë˜í”„ëŠ” ìƒí’ˆë³„ ìƒì„¸ ì •ë³´ í™”ë©´ì—ì„œë§Œ
          ë Œë”ë§ #} {% if charts.product_sales %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-green-100 flex items-center justify-center"
              >
                <i class="fas fa-box text-green-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">ìƒí’ˆë³„ íŒë§¤</h3>
                <p class="text-sm text-gray-500">ìƒìœ„ 10ê°œ ìƒí’ˆ íŒë§¤ëŸ‰</p>
              </div>
            </div>
            <div
              id="echart-product-sales"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %} {% if charts.color_sales %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-purple-100 flex items-center justify-center"
              >
                <i class="fas fa-palette text-purple-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">ì»¬ëŸ¬ë³„ íŒë§¤</h3>
                <p class="text-sm text-gray-500">ì¸ê¸° ì»¬ëŸ¬ ë¶„ì„</p>
              </div>
            </div>
            <div
              id="echart-color-sales"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %} {% if charts.size_sales %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-yellow-100 flex items-center justify-center"
              >
                <i class="fas fa-ruler text-yellow-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">
                  ì‚¬ì´ì¦ˆë³„ íŒë§¤
                </h3>
                <p class="text-sm text-gray-500">ì¸ê¸° ì‚¬ì´ì¦ˆ ë¶„ì„</p>
              </div>
            </div>
            <div
              id="echart-size-sales"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %}
        </div>

        <!-- Additional Charts -->
        {% if charts.pareto_analysis %}
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-indigo-100 flex items-center justify-center"
              >
                <i class="fas fa-chart-pie text-indigo-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">íŒŒë ˆí†  ë¶„ì„</h3>
                <p class="text-sm text-gray-500">
                  ìƒí’ˆë³„ ë§¤ì¶œ ì§‘ì¤‘ë„ ë¶„ì„ (80% ê¸°ì¤€)
                </p>
              </div>
            </div>
            <div
              id="echart-pareto-analysis"
              style="width: 100%; height: 300px"
            ></div>
          </div>
        </div>
        {% endif %}

        <!-- ECharts ë Œë”ë§ ìŠ¤í¬ë¦½íŠ¸ -->
        <script>
          document.addEventListener('DOMContentLoaded', function() {
              // íŒë§¤ ì¶”ì„¸
              {% if charts.sales_trend %}
              var option_sales_trend = {{ charts.sales_trend.config|tojson }};
              option_sales_trend.title = {text: '{{ charts.sales_trend.title }}', left: 'center'};
              option_sales_trend.tooltip = {trigger: 'axis'};
              option_sales_trend.legend = option_sales_trend.legend || {};
              option_sales_trend.legend.top = 'bottom';
              var chartDom1 = document.getElementById('echart-sales-trend');
              if (chartDom1) {
                  var myChart1 = echarts.init(chartDom1);
                  myChart1.setOption(option_sales_trend);
              }

              {% endif %}
              // ì£¼ë³„ íŒë§¤ ì¶”ì„¸
              {% if plots.weekly_sales_trend %}
              var option_weekly_sales_trend = {{ plots.weekly_sales_trend.config|tojson }};
              // ì œëª© ì œê±°
              option_weekly_sales_trend.title = undefined;
              option_weekly_sales_trend.tooltip = {trigger: 'axis'};

              var chartDomWeekly = document.getElementById('echart-weekly-sales-trend');
              if (chartDomWeekly) {
                  var myChartWeekly = echarts.init(chartDomWeekly);
                  myChartWeekly.setOption(option_weekly_sales_trend);
              }
              {% endif %}
              // ìƒí’ˆë³„ íŒë§¤
              {% if charts.product_sales %}
              var option_product_sales = {{ charts.product_sales.config|tojson }};
              option_product_sales.title = {text: '{{ charts.product_sales.title }}', left: 'center'};
              option_product_sales.tooltip = {trigger: 'axis'};
              var chartDom2 = document.getElementById('echart-product-sales');
              if (chartDom2) {
                  var myChart2 = echarts.init(chartDom2);
                  myChart2.setOption(option_product_sales);
              }
              {% endif %}
              // ì»¬ëŸ¬ë³„ íŒë§¤
              {% if charts.color_sales %}
              var option_color_sales = {{ charts.color_sales.config|tojson }};
              option_color_sales.title = {text: '{{ charts.color_sales.title }}', left: 'center'};
              option_color_sales.tooltip = {trigger: 'axis'};
              var chartDom3 = document.getElementById('echart-color-sales');
              if (chartDom3) {
                  var myChart3 = echarts.init(chartDom3);
                  myChart3.setOption(option_color_sales);
              }
              {% endif %}
              // ì‚¬ì´ì¦ˆë³„ íŒë§¤
              {% if charts.size_sales %}
              var option_size_sales = {{ charts.size_sales.config|tojson }};
              option_size_sales.title = {text: '{{ charts.size_sales.title }}', left: 'center'};
              option_size_sales.tooltip = {trigger: 'axis'};
              var chartDom4 = document.getElementById('echart-size-sales');
              if (chartDom4) {
                  var myChart4 = echarts.init(chartDom4);
                  myChart4.setOption(option_size_sales);
              }
              {% endif %}
              // íŒŒë ˆí†  ë¶„ì„
              {% if charts.pareto_analysis %}
              var option_pareto = {{ charts.pareto_analysis.config|tojson }};
              option_pareto.title = {text: '{{ charts.pareto_analysis.title }}', left: 'center'};
              option_pareto.tooltip = {trigger: 'axis'};
              var chartDom5 = document.getElementById('echart-pareto-analysis');
              if (chartDom5) {
                  var myChart5 = echarts.init(chartDom5);
                  myChart5.setOption(option_pareto);
              }
              {% endif %}
          });
        </script>
        {% endif %}
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥ - ì™„ì „íˆ ìƒˆë¡œ ì‘ì„±
      document.addEventListener("DOMContentLoaded", function () {
        console.log("=== ì •ë ¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ===");

        const table = document.getElementById("alertTable");
        if (!table) {
          console.log("âŒ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        console.log("âœ… í…Œì´ë¸” ë°œê²¬");

        // í…Œì´ë¸” í—¤ë”ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        const headers = table.querySelectorAll("th.sortable-header");
        console.log("ì •ë ¬ ê°€ëŠ¥í•œ í—¤ë” ê°œìˆ˜:", headers.length);

        headers.forEach((header) => {
          header.style.cursor = "pointer";
          header.addEventListener("click", function (e) {
            console.log("ğŸ”¥ í—¤ë” í´ë¦­ë¨:", this.getAttribute("data-sort"));

            const column = this.getAttribute("data-sort");
            const currentDirection =
              this.getAttribute("data-direction") || "asc";
            const newDirection = currentDirection === "asc" ? "desc" : "asc";

            console.log("ì •ë ¬ ì»¬ëŸ¼:", column, "ë°©í–¥:", newDirection);

            // ëª¨ë“  í—¤ë”ì˜ ë°©í–¥ ì´ˆê¸°í™”
            headers.forEach((h) => {
              h.setAttribute("data-direction", "");
              h.style.backgroundColor = "";
            });

            // í˜„ì¬ í—¤ë”ì— ë°©í–¥ ì„¤ì •
            this.setAttribute("data-direction", newDirection);
            this.style.backgroundColor = "#f3f4f6";

            // í…Œì´ë¸” ì •ë ¬ ì‹¤í–‰
            sortTable(table, column, newDirection);
          });
        });

        function sortTable(table, column, direction) {
          console.log("ğŸ”„ ì •ë ¬ ì‹œì‘:", column, direction);

          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));

          console.log("ì •ë ¬í•  í–‰ ê°œìˆ˜:", rows.length);

          rows.sort((a, b) => {
            const aCell = a.querySelector(`td[data-sort="${column}"]`);
            const bCell = b.querySelector(`td[data-sort="${column}"]`);

            if (!aCell || !bCell) {
              console.log("ì…€ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:", column);
              return 0;
            }

            let aValue = aCell.getAttribute("data-sort-value") || "";
            let bValue = bCell.getAttribute("data-sort-value") || "";

            console.log("ë¹„êµ ê°’:", aValue, "vs", bValue);

            // ë°œì£¼ì œì•ˆ ì»¬ëŸ¼ì€ ìˆ«ìë¡œ ì²˜ë¦¬
            if (column === "order") {
              aValue = parseInt(aValue) || 0;
              bValue = parseInt(bValue) || 0;
              return direction === "asc" ? aValue - bValue : bValue - aValue;
            }

            // ìˆ«ì ì •ë ¬
            if (
              !isNaN(aValue) &&
              !isNaN(bValue) &&
              aValue !== "" &&
              bValue !== ""
            ) {
              return direction === "asc"
                ? parseFloat(aValue) - parseFloat(bValue)
                : parseFloat(bValue) - parseFloat(aValue);
            }

            // ë‚ ì§œ ì •ë ¬
            const aDate = new Date(aValue);
            const bDate = new Date(bValue);
            if (!isNaN(aDate) && !isNaN(bDate)) {
              return direction === "asc" ? aDate - bDate : bDate - aDate;
            }

            // ë¬¸ìì—´ ì •ë ¬
            return direction === "asc"
              ? aValue.localeCompare(bValue)
              : bValue.localeCompare(aValue);
          });

          // ì •ë ¬ëœ í–‰ì„ í…Œì´ë¸”ì— ë‹¤ì‹œ ì¶”ê°€
          rows.forEach((row) => tbody.appendChild(row));
          console.log("âœ… ì •ë ¬ ì™„ë£Œ");
        }
      });
      // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ê¸°ëŠ¥
      document.addEventListener("DOMContentLoaded", function () {
        // í˜„ì¬ ì„ íƒëœ ìƒí’ˆì´ ìˆëŠ”ì§€ í™•ì¸
        const currentProduct = "{{ selected_product }}";
        if (!currentProduct) {
          return; // ìƒí’ˆì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ë¹„í™œì„±í™”
        }

        // ì‚¬ì´ë“œë°”ì—ì„œ ìƒí’ˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const productLinks = document.querySelectorAll(
          'nav a[href*="product="]'
        );
        const products = Array.from(productLinks).map((link) => {
          const url = new URL(link.href);
          return url.searchParams.get("product");
        });

        if (products.length <= 1) {
          return; // ìƒí’ˆì´ 1ê°œ ì´í•˜ë©´ ë„¤ë¹„ê²Œì´ì…˜ ë¶ˆí•„ìš”
        }

        // í˜„ì¬ ìƒí’ˆì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
        const currentIndex = products.indexOf(currentProduct);
        if (currentIndex === -1) {
          return;
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener("keydown", function (e) {
          // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ë¹„í™œì„±í™”
          if (
            e.target.tagName === "INPUT" ||
            e.target.tagName === "TEXTAREA" ||
            e.target.tagName === "SELECT"
          ) {
            return;
          }

          let nextIndex = -1;

          if (e.key === "ArrowLeft") {
            // ì™¼ìª½ í™”ì‚´í‘œ: ì´ì „ ìƒí’ˆ
            nextIndex =
              currentIndex > 0 ? currentIndex - 1 : products.length - 1;
            e.preventDefault();
          } else if (e.key === "ArrowRight") {
            // ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ: ë‹¤ìŒ ìƒí’ˆ
            nextIndex =
              currentIndex < products.length - 1 ? currentIndex + 1 : 0;
            e.preventDefault();
          }

          if (nextIndex !== -1 && nextIndex !== currentIndex) {
            const nextProduct = products[nextIndex];
            window.location.href = `/dashboard?product=${encodeURIComponent(
              nextProduct
            )}`;
          }
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì•ˆë‚´ í‘œì‹œ
        const header = document.querySelector("header");
        if (header) {
          const keyboardInfo = document.createElement("div");
          keyboardInfo.className = "text-xs text-gray-400 mt-1";
          keyboardInfo.innerHTML =
            '<i class="fas fa-keyboard mr-1"></i>â† â†’ í‚¤ë¡œ ìƒí’ˆ ì´ë™';
          header
            .querySelector(".flex.items-center.space-x-4")
            .appendChild(keyboardInfo);
        }
      });
    </script>
  </body>
</html>
