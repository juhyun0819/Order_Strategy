<!DOCTYPE html>
<html lang="ko" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>여성복 의류 도매 - 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='output.css') }}"
      rel="stylesheet"
    />
    <style>
      .th-sort {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        cursor: pointer;
        user-select: none;
      }
      .sort-arrows {
        display: inline-flex;
        flex-direction: column;
        margin-left: 2px;
        font-size: 12px;
        line-height: 1;
      }
      .sort-arrow {
        color: #cbd5e1;
        transition: color 0.2s, transform 0.15s;
        cursor: pointer;
        height: 16px;
        display: block;
      }
      .sort-arrow:hover {
        color: #2563eb;
        transform: scale(1.25) translateY(-1px);
      }
      .sort-arrow.active {
        color: #2563eb;
        font-weight: bold;
        transform: scale(1.25);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg">
      <div class="flex h-16 items-center border-b px-6">
        <div class="flex items-center space-x-2">
          <div
            class="h-8 w-8 rounded-lg bg-blue-600 flex items-center justify-center"
          >
            <i class="fas fa-tshirt text-white text-sm"></i>
          </div>
          <span class="text-lg font-semibold">의류 도매</span>
        </div>
      </div>
      <nav class="flex-1 space-y-1 px-3 py-4">
        <!-- 대시보드 탭 -->
        <a
          href="/dashboard"
          class="flex items-center space-x-3 rounded-lg px-3 py-2 text-gray-700 transition-colors {% if not selected_product %} bg-gray-100 font-bold {% else %} hover:bg-gray-100 {% endif %}"
        >
          <i class="fas fa-chart-line text-gray-500"></i>
          <span>대시보드</span>
        </a>
        <form method="post" action="/reset-db" onsubmit="return confirm('정말로 데이터베이스를 초기화하시겠습니까?')">
          <button type="submit" class="w-full flex items-center space-x-3 rounded-lg px-3 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
            <i class="fas fa-trash text-gray-500"></i>
            <span>DB 초기화</span>
          </button>
        </form>
        
        <!-- 파레토 설정 -->
        <div class="px-3 py-2">
          <form method="post" class="space-y-2">
            <input type="hidden" name="pareto_settings_form" value="1" />
            <div class="flex items-center space-x-1">
              <label class="text-xs text-gray-600 font-medium">파레토 기준:</label>
              <input
                type="number"
                name="pareto_days"
                min="1"
                max="3650"
                value="{{ pareto_days if pareto_days else 365 }}"
                class="w-12 text-xs px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                placeholder="일"
              />
              <span class="text-xs text-gray-500">일</span>
              <button
                type="submit"
                class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
              >
                설정
              </button>
            </div>
          </form>
        </div>
        {% if sidebar_products or sidebar_colors %}
        <div
          class="mt-6 overflow-y-auto"
          style="max-height: calc(100vh - 180px)"
        >
          <!-- 파레토 탭 -->
          <div class="text-xs text-gray-400 font-semibold mb-2 pl-2">
            파레토 분석
          </div>
          
          <!-- 탭 버튼 -->
          <div class="flex mb-2 px-2">
            <button
              id="product-tab"
              class="flex-1 text-xs px-2 py-1 rounded-l-md transition-colors bg-blue-100 text-blue-700 font-medium"
              onclick="switchTab('product')"
            >
              상품별
            </button>
            <button
              id="color-tab"
              class="flex-1 text-xs px-2 py-1 rounded-r-md transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200"
              onclick="switchTab('color')"
            >
              컬러별
            </button>
          </div>
          
          <!-- 상품별 파레토 리스트 -->
          <ul id="product-list" class="space-y-1">
            {% for product in sidebar_products %}
            <li>
              <a
                href="/dashboard?product={{ product }}"
                class="block px-3 py-2 rounded-lg transition-colors truncate {% if selected_product == product %} bg-blue-100 text-blue-700 font-bold {% else %} text-gray-700 hover:bg-blue-50 hover:text-blue-700 {% endif %}"
                title="{{ product }}"
              >
                <span class="mr-2 text-xs font-bold">{{ loop.index }}</span>{{ product }}
              </a>
            </li>
            {% endfor %}
          </ul>
          
          <!-- 컬러별 파레토 리스트 -->
          <ul id="color-list" class="space-y-1 hidden">
            {% for product, color in sidebar_colors %}
            <li>
              <a
                href="/dashboard?product={{ product }}&color={{ color }}"
                class="block px-3 py-2 rounded-lg transition-colors truncate {% if selected_product == product and selected_color == color %} bg-blue-100 text-blue-700 font-bold {% else %} text-gray-700 hover:bg-blue-50 hover:text-blue-700 {% endif %}"
                title="{{ product }} - {{ color }}"
              >
                <span class="mr-2 text-xs font-bold">{{ loop.index }}</span>{{ product }} - {{ color }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
        
        <script>
          function switchTab(tab) {
            const productTab = document.getElementById('product-tab');
            const colorTab = document.getElementById('color-tab');
            const productList = document.getElementById('product-list');
            const colorList = document.getElementById('color-list');
            
            if (tab === 'product') {
              productTab.className = 'flex-1 text-xs px-2 py-1 rounded-l-md transition-colors bg-blue-100 text-blue-700 font-medium';
              colorTab.className = 'flex-1 text-xs px-2 py-1 rounded-r-md transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200';
              productList.classList.remove('hidden');
              colorList.classList.add('hidden');
            } else {
              productTab.className = 'flex-1 text-xs px-2 py-1 rounded-l-md transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200';
              colorTab.className = 'flex-1 text-xs px-2 py-1 rounded-r-md transition-colors bg-blue-100 text-blue-700 font-medium';
              productList.classList.add('hidden');
              colorList.classList.remove('hidden');
            }
            
            // 탭 전환 후 키보드 네비게이션 재설정
            setTimeout(() => {
              setupKeyboardNavigation();
            }, 100);
          }
          
          // 페이지 로드 시 현재 선택에 따라 탭 설정 (자동 전환 없이)
          document.addEventListener('DOMContentLoaded', function() {
            const selectedProduct = "{{ selected_product }}";
            const selectedColor = "{{ selected_color }}";
            
            // URL에서 직접 컬러 파라미터가 있는 경우에만 컬러별 탭 활성화
            const urlParams = new URLSearchParams(window.location.search);
            const hasColorParam = urlParams.has('color');
            
            if (hasColorParam && selectedColor) {
              // URL에 color 파라미터가 있고 컬러가 선택된 경우에만 컬러별 탭 활성화
              switchTab('color');
            }
            // 그 외의 경우는 현재 탭 상태 유지 (자동 전환 안함)
          });
        </script>
        {% endif %}
      </nav>
    </div>

    <!-- Main content -->
    <div class="pl-64">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="flex h-16 items-center justify-between px-6">
          <div>
            <h1 class="text-2xl font-semibold text-gray-900">Dashboard</h1>
            <p class="text-sm text-gray-500">여성복 의류 도매 현황</p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div class="h-2 w-2 rounded-full bg-green-500"></div>
              <span class="text-sm text-gray-500">시스템 정상</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Page content -->
      <main class="p-6">
        {% if selected_product %}
        <!-- 상품별 상세 정보 화면 -->
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-tshirt text-blue-600"></i>
              </div>
              <div class="flex-1 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900 inline-block">
                  {{ display_name }}
                </h2>
                <!-- 주차별 거래처 수 입력란 -->
                <form
                  method="post"
                  class="flex items-center"
                >
                  <input type="hidden" name="weekly_client_count_form" value="1" />
                  <input
                    type="number"
                    min="0"
                    name="weekly_client_count"
                    class="form-control w-32 mr-2"
                    placeholder="주차별 거래처"
                    value="{{ current_week_client_count if current_week_client_count is not none else '' }}"
                  />
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-save"></i>
                  </button>
                </form>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div class="bg-gray-50 rounded-lg p-4 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">누적 판매량</div>
                <div class="text-2xl font-bold text-blue-700">
                  {{ stats.product_total_sales }}
                </div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">현재고</div>
                <div class="text-2xl font-bold text-green-700">
                  {{ stats.product_current_stock }}
                </div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">최근 7일 판매량</div>
                <div class="text-2xl font-bold text-pink-700">
                  {{ stats.product_7days_sales }}
                </div>
              </div>
            </div>
            <!-- 예측 및 발주 제안 카드 (오늘의 중위 추세선, 발주제안) -->
            <div class="w-full mb-6">
              <div class="bg-white rounded-lg p-4 flex flex-row items-stretch shadow border">
                <!-- 예측값(중위 추세선) -->
                <div class="flex-1 flex flex-col items-center justify-center pr-4 border-r">
                  <div class="flex items-center mb-2">
                    <div class="h-8 w-8 rounded-lg bg-yellow-100 flex items-center justify-center mr-2">
                      <i class="fas fa-lightbulb text-yellow-500"></i>
                    </div>
                    <span class="text-sm font-semibold text-gray-700">예측값 (중위 추세선)</span>
                  </div>
                  <div class="text-2xl font-bold text-indigo-700 mb-2">
                    {{ plots.today_mid_trend if plots.today_mid_trend is not none else '-' }}
                  </div>
                </div>
                <!-- 발주 제안 -->
                <div class="flex-1 flex flex-col items-center justify-center pl-4">
                  <div class="flex items-center mb-2">
                    <div class="h-8 w-8 rounded-lg bg-pink-100 flex items-center justify-center mr-2">
                      <i class="fas fa-truck text-pink-500"></i>
                    </div>
                    <span class="text-sm font-semibold text-gray-700">발주 제안</span>
                  </div>
                  <div class="text-lg font-bold text-pink-700 mb-2">
                    {%- set mid = plots.today_mid_trend if plots.today_mid_trend is not none else None -%}
                    {%- set stock = stats.product_current_stock if stats.product_current_stock is not none else None -%}
                    {%- if mid is not none and stock is not none -%}
                      {%- set lack = (mid|float - stock|float)|round -%}
                      {%- if lack > 0 -%}
                        {{ lack }}개 발주 필요
                      {%- else -%}
                        충분
                      {%- endif -%}
                    {%- else -%}
                      -
                    {%- endif -%}
                  </div>
                </div>
              </div>
            </div>
            <!-- 비교 상품 업로드 UI (상품별 페이지에서만 표시) -->
            {% if selected_product %}
            <div class="mb-6" style="background: #f8fafc; border-radius: 0.5rem; padding: 1rem">
              <form method="post" enctype="multipart/form-data" class="flex items-center gap-4 w-full">
                <input type="file" name="compare_file" id="compare_file" accept=".xls,.xlsx" class="form-control flex-1 min-w-0" required />
                <button type="submit" name="compare_upload" value="1" class="btn btn-primary px-6 py-2 text-base font-semibold" style="min-width: 90px;">업로드</button>
              </form>
              {% if compare_df is not none %}
              <div class="flex items-center justify-between mt-2">
                <div class="text-sm text-green-600">
                  <i class="fas fa-check-circle"></i> 비교 상품 데이터{% if compare_filename %} ({{ compare_filename }}){% endif %}가 저장되어 있습니다.
                </div>
                <form method="post" class="inline">
                  <button type="submit" name="delete_compare" value="1" class="btn btn-danger px-6 py-2 text-base font-semibold" onclick="return confirm('비교 상품 데이터를 삭제하시겠습니까?')">
                    <i class="fas fa-trash"></i> 삭제
                  </button>
                </form>
              </div>
              {% endif %}
            </div>
            {% endif %}
            {% if plots.sales_trend %}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                판매 추세
              </h3>
              <div
                id="echart-product-sales-trend"
                style="width: 100%; height: 450px"
              ></div>
            </div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                  var option_product_sales_trend = {{ plots.sales_trend.config|tojson }};
                  option_product_sales_trend.tooltip = {trigger: 'axis'};

                  var chartDomProduct = document.getElementById('echart-product-sales-trend');
                  if (chartDomProduct) {
                      var myChartProduct = echarts.init(chartDomProduct);
                      myChartProduct.setOption(option_product_sales_trend);
                  }
              });
            </script>
            {% endif %}             {% if plots.weekly_sales_trend %}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">주별 판매량</h3>
              <div
                id="echart-product-weekly-sales-trend"
                style="width: 100%; height: 450px"
              ></div>
            </div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                  // 주차별 날짜 범위 정보를 window에 할당
                  var weekDateRanges = {};
                  var option_weekly_sales_trend = {};
                  
                  {% if plots and plots.weekly_sales_trend %}
                  {% if plots.weekly_sales_trend.data %}
                  weekDateRanges = {{ plots.weekly_sales_trend.data.week_date_ranges|tojson }};
                  {% endif %}
                  {% if plots.weekly_sales_trend.config %}
                  option_weekly_sales_trend = {{ plots.weekly_sales_trend.config|tojson }};
                  {% endif %}
                  {% endif %}
                  
                  window.weekDateRanges = weekDateRanges;
                  option_weekly_sales_trend.title = undefined;
                  option_weekly_sales_trend.tooltip = {
                      trigger: 'axis',
                      axisPointer: {
                          type: 'cross',
                          label: {
                              backgroundColor: '#6a7985'
                          }
                      },
                      formatter: function(params) {
                          var week = params[0].axisValue;
                          var weekDateRanges = window.weekDateRanges || {};
                          var dateRange = weekDateRanges[week] || "";
                          var result = week + '주차';
                          if (dateRange) {
                              result += ' (' + dateRange + ')';
                          }
                          result += '<br/>';
                          params.forEach(function(param) {
                              if (param.value !== null && param.value !== undefined) {
                                  result += param.marker + param.seriesName + ': ' + param.value + '<br/>';
                              }
                          });
                          return result;
                      }
                  };

                  var chartDomWeekly = document.getElementById('echart-product-weekly-sales-trend');
                  if (chartDomWeekly) {
                      var myChartWeekly = echarts.init(chartDomWeekly);
                      myChartWeekly.setOption(option_weekly_sales_trend);
                  }
              });
            </script>
            {% endif %}
          </div>
        </div>
        {% else %}
        <!-- 기존 전체 대시보드 -->
        <!-- Upload Section -->
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-upload text-blue-600"></i>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-gray-900">
                  엑셀 파일 업로드
                </h2>
                <p class="text-sm text-gray-500">
                  여러 개의 엑셀 파일을 한 번에 업로드할 수 있습니다
                </p>
              </div>
            </div>

            <div class="space-y-4 mb-6">
              <div class="flex items-start space-x-2 text-sm text-gray-600">
                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                <span
                  >파일명에 날짜(예: 25.06.29.xlsx)가 포함되어 있으면 자동으로
                  판매일자로 인식됩니다</span
                >
              </div>
              <div class="flex items-start space-x-2 text-sm text-gray-600">
                <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                <span
                  >필수 컬럼:
                  <strong
                    >품명, 칼라(색상), 사이즈, 실판매, 현재고, 미송잔량</strong
                  ></span
                >
              </div>
              <div class="flex items-start space-x-2 text-sm text-gray-600">
                <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5"></i>
                <span
                  >컬럼명이 정확하지 않으면 업로드가 실패할 수 있습니다. 엑셀 파일의 첫 번째 행(헤더)을 확인해주세요.</span
                >
              </div>
            </div>

            <form
              method="POST"
              enctype="multipart/form-data"
              class="flex gap-4"
            >
              <div class="flex-1">
                <input
                  type="file"
                  name="files"
                  class="form-control"
                  multiple
                  accept=".xls,.xlsx"
                />
              </div>
              <button type="submit" class="btn btn-primary px-8">
                <i class="fas fa-upload mr-2"></i>업로드
              </button>
            </form>
          </div>
        </div>

        <!-- Date Delete Section -->
        {% if stats.sales_dates > 0 %}
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-red-100 flex items-center justify-center"
              >
                <i class="fas fa-calendar-times text-red-600"></i>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-gray-900">
                  날짜별 데이터 삭제
                </h2>
                <p class="text-sm text-gray-500">
                  특정 날짜의 데이터를 삭제할 수 있습니다
                </p>
              </div>
            </div>

            <form method="post" action="/delete-date" class="flex gap-4">
              <div class="flex-1">
                <label for="date" class="form-label">삭제할 날짜 선택</label>
                <select name="date" id="date" class="form-control" required>
                  <option value="">날짜를 선택하세요</option>
                  {% for date in unique_dates %}
                  <option value="{{ date }}">{{ date }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex items-end">
                <button
                  type="submit"
                  class="btn btn-danger px-8"
                  onclick="return confirm('정말로 이 날짜의 데이터를 삭제하시겠습니까?')"
                >
                  <i class="fas fa-trash mr-2"></i>삭제
                </button>
              </div>
            </form>
          </div>
        </div>
        {% endif %}

        <!-- Alert Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %}
        <div class="mb-8">
          {% for category, message in messages %}
          <div
            class="alert alert-{{ 'danger' if category == 'error' else category }} mb-4"
          >
            {{ message }}
            <button
              type="button"
              class="float-right text-lg font-bold leading-none text-current opacity-50 hover:opacity-75"
              onclick="this.parentElement.remove()"
            >
              <span class="sr-only">Close</span>
              ×
            </button>
          </div>
          {% endfor %}
        </div>
        {% endif %} {% endwith %}

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">총 데이터 수</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ "{:,}".format(stats.total_items) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-boxes text-blue-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">총 판매량</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ "{:,}".format(stats.total_sales) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-green-100 flex items-center justify-center"
              >
                <i class="fas fa-chart-line text-green-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">최근 7일 판매량</p>
                <p class="text-2xl font-bold text-pink-700">
                  {{ "{:,}".format(stats.recent_7days_sales) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-pink-100 flex items-center justify-center"
              >
                <i class="fas fa-calendar-week text-pink-600"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">총 미송잔량</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ "{:,}".format(stats.total_pending) }}
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-lg bg-purple-100 flex items-center justify-center"
              >
                <i class="fas fa-truck text-purple-600"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- 추세선 알림 -->
        {% if trend_alerts %}
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-6 border-b">
              <div class="flex items-center space-x-3">
                <div
                  class="h-10 w-10 rounded-lg bg-orange-100 flex items-center justify-center"
                >
                  <i class="fas fa-chart-line text-orange-600"></i>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900">
                    추세선 벗어남 알림
                  </h2>
                  <p class="text-sm text-gray-500">
                    전년 추세선을 벗어나는 판매량을 확인하세요
                  </p>
                </div>
              </div>
            </div>
            <div class="p-6">
              <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for alert in trend_alerts %}
                <div class="flex items-center p-4 rounded-lg {% if alert.type == 'high' %}bg-red-50 border border-red-200{% else %}bg-orange-50 border border-orange-200{% endif %}">
                  <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle {% if alert.type == 'high' %}text-red-500{% else %}text-orange-500{% endif %} mr-3"></i>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-medium {% if alert.type == 'high' %}text-red-800{% else %}text-orange-800{% endif %}">
                      {{ alert.message }}
                    </p>
                    <p class="text-xs text-gray-600 mt-1">
                      {% if alert.type == 'high' %}
                        <span class="text-red-600 font-medium">고점 추세 초과</span>
                      {% else %}
                        <span class="text-orange-600 font-medium">저점 추세 미달</span>
                      {% endif %}
                    </p>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- 알림/파레토/상품별 그래프/파레토 분석 등 전체 상품용 섹션 -->
        {% if alert_df is not none and not alert_df.empty %}
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-6 border-b">
              <div class="flex items-center space-x-3">
                <div
                  class="h-10 w-10 rounded-lg bg-red-100 flex items-center justify-center"
                >
                  <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900">
                    재고 예측/발주 알림
                  </h2>
                  <p class="text-sm text-gray-500">
                    재고 부족 위험 상품들을 확인하세요
                  </p>
                </div>
              </div>
            </div>
            <div class="overflow-x-auto max-h-96 overflow-y-auto">
              <table class="table" id="alertTable">
                <thead>
                  <tr>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="date"
                    >
                      <span class="flex items-center justify-start">
                        날짜
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="product"
                    >
                      <span class="flex items-center justify-start">
                        상품명
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="trend"
                    >
                      <span class="flex items-center justify-start">
                        최근 판매 경향
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="baseline"
                    >
                      <span class="flex items-center justify-start">
                        중간선
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="current"
                    >
                      <span class="flex items-center justify-center">
                        현재고
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="shortage"
                    >
                      <span class="flex items-center justify-center">
                        부족수량
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="order"
                    >
                      <span class="flex items-center justify-start">
                        발주제안
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="depletion"
                    >
                      <span class="flex items-center justify-start">
                        소진예상일
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                    <th
                      class="sortable-header sticky top-0 bg-white z-10 align-middle"
                      data-sort="alert"
                    >
                      <span class="flex items-center justify-start">
                        경고등급
                        <span class="sort-arrows ml-3 -mt-1">
                          <i
                            class="fas fa-chevron-up sort-arrow"
                            data-direction="asc"
                          ></i>
                          <i
                            class="fas fa-chevron-down sort-arrow"
                            data-direction="desc"
                          ></i>
                        </span>
                      </span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for _, row in alert_df.iterrows() %}
                  <tr>
                    <td data-sort-value="{{ row['날짜'] }}" data-sort="date">
                      {{ row['날짜'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['상품명'] }}"
                      data-sort="product"
                    >
                      {{ row['상품명'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['최근 판매 경향'] }}"
                      data-sort="trend"
                    >
                      {% if row['최근 판매 경향'] == '증가' %}
                      <span class="badge badge-primary">증가</span>
                      {% elif row['최근 판매 경향'] == '감소' %}
                      <span class="badge badge-destructive">감소</span>
                      {% else %}
                      <span class="badge badge-secondary">유지</span>
                      {% endif %}
                    </td>
                    <td
                      data-sort-value="{{ row['중간선'] }}"
                      data-sort="baseline"
                    >
                      {{ row['중간선'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['현재고'] }}"
                      data-sort="current"
                    >
                      {{ row['현재고'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['부족수량'] }}"
                      data-sort="shortage"
                    >
                      {% if row['부족수량'] > 0 %}
                      <span class="badge badge-destructive"
                        >{{ row['부족수량'] }}</span
                      >
                      {% else %}
                      <span class="badge badge-primary">0</span>
                      {% endif %}
                    </td>
                    {%- set order_value = 9999 -%} {%- if row['발주제안'] is
                    string and '발주 필요' in row['발주제안'] -%} {%- set
                    order_value = row['발주제안'].split('개')[0]|int -%} {%-
                    elif row['발주제안'] == '충분' -%} {%- set order_value = 0
                    -%} {%- endif -%}
                    <td data-sort-value="{{ order_value }}" data-sort="order">
                      {{ row['발주제안'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['소진예상일'] }}"
                      data-sort="depletion"
                    >
                      {{ row['소진예상일'] }}
                    </td>
                    <td
                      data-sort-value="{{ row['경고등급'] }}"
                      data-sort="alert"
                    >
                      {% if row['경고등급'] == '위험' %}
                      <span class="badge badge-destructive">위험</span>
                      {% elif row['경고등급'] == '주의' %}
                      <span class="badge badge-secondary">주의</span>
                      {% else %}
                      <span class="badge badge-primary">안정</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {% if charts.sales_trend %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-chart-line text-blue-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">판매 추세</h3>
                <p class="text-sm text-gray-500">일별 판매량 추이</p>
              </div>
            </div>
            <div
              id="echart-sales-trend"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %} {# 주별 판매추세 그래프는 상품별 상세 정보 화면에서만
          렌더링 #} {% if charts.product_sales %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-green-100 flex items-center justify-center"
              >
                <i class="fas fa-box text-green-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">상품별 판매</h3>
                <p class="text-sm text-gray-500">상위 10개 상품 판매량</p>
              </div>
            </div>
            <div
              id="echart-product-sales"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %} {% if charts.color_sales %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-purple-100 flex items-center justify-center"
              >
                <i class="fas fa-palette text-purple-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">컬러별 판매</h3>
                <p class="text-sm text-gray-500">인기 컬러 분석</p>
              </div>
            </div>
            <div
              id="echart-color-sales"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %} {% if charts.size_sales %}
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-yellow-100 flex items-center justify-center"
              >
                <i class="fas fa-ruler text-yellow-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">
                  사이즈별 판매
                </h3>
                <p class="text-sm text-gray-500">인기 사이즈 분석</p>
              </div>
            </div>
            <div
              id="echart-size-sales"
              style="width: 100%; height: 300px"
            ></div>
          </div>
          {% endif %}
        </div>

        <!-- Additional Charts -->
        {% if charts.pareto_analysis %}
        <div class="mb-8">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="h-10 w-10 rounded-lg bg-indigo-100 flex items-center justify-center"
              >
                <i class="fas fa-chart-pie text-indigo-600"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">파레토 분석</h3>
                <p class="text-sm text-gray-500">
                  상품별 매출 집중도 분석 (80% 기준)
                </p>
              </div>
            </div>
            <div
              id="echart-pareto-analysis"
              style="width: 100%; height: 300px"
            ></div>
          </div>
        </div>
        {% endif %}

        <!-- ECharts 렌더링 스크립트 -->
        <script>
          document.addEventListener('DOMContentLoaded', function() {
              // 판매 추세
              {% if charts.sales_trend %}
              var option_sales_trend = {{ charts.sales_trend.config|tojson }};
              option_sales_trend.title = {text: '{{ charts.sales_trend.title }}', left: 'center'};
              option_sales_trend.tooltip = {trigger: 'axis'};
              var chartDom1 = document.getElementById('echart-sales-trend');
              if (chartDom1) {
                  var myChart1 = echarts.init(chartDom1);
                  myChart1.setOption(option_sales_trend);
              }

              {% endif %}
              // 주별 판매 추세
              {% if plots.weekly_sales_trend %}
              var option_weekly_sales_trend = {{ plots.weekly_sales_trend.config|tojson }};
              // 제목 제거
              option_weekly_sales_trend.title = undefined;
              option_weekly_sales_trend.tooltip = {trigger: 'axis'};

              var chartDomWeekly = document.getElementById('echart-product-weekly-sales-trend');
              if (chartDomWeekly) {
                  var myChartWeekly = echarts.init(chartDomWeekly);
                  myChartWeekly.setOption(option_weekly_sales_trend);
              }
              {% endif %}
              // 상품별 판매
              {% if charts.product_sales %}
              var option_product_sales = {{ charts.product_sales.config|tojson }};
              option_product_sales.title = {text: '{{ charts.product_sales.title }}', left: 'center'};
              option_product_sales.tooltip = {trigger: 'axis'};
              var chartDom2 = document.getElementById('echart-product-sales');
              if (chartDom2) {
                  var myChart2 = echarts.init(chartDom2);
                  myChart2.setOption(option_product_sales);
              }
              {% endif %}
              // 컬러별 판매
              {% if charts.color_sales %}
              var option_color_sales = {{ charts.color_sales.config|tojson }};
              option_color_sales.title = {text: '{{ charts.color_sales.title }}', left: 'center'};
              option_color_sales.tooltip = {trigger: 'axis'};
              var chartDom3 = document.getElementById('echart-color-sales');
              if (chartDom3) {
                  var myChart3 = echarts.init(chartDom3);
                  myChart3.setOption(option_color_sales);
              }
              {% endif %}
              // 사이즈별 판매
              {% if charts.size_sales %}
              var option_size_sales = {{ charts.size_sales.config|tojson }};
              option_size_sales.title = {text: '{{ charts.size_sales.title }}', left: 'center'};
              option_size_sales.tooltip = {trigger: 'axis'};
              var chartDom4 = document.getElementById('echart-size-sales');
              if (chartDom4) {
                  var myChart4 = echarts.init(chartDom4);
                  myChart4.setOption(option_size_sales);
              }
              {% endif %}
              // 파레토 분석
              {% if charts.pareto_analysis %}
              var option_pareto = {{ charts.pareto_analysis.config|tojson }};
              option_pareto.title = {text: '{{ charts.pareto_analysis.title }}', left: 'center'};
              option_pareto.tooltip = {trigger: 'axis'};
              var chartDom5 = document.getElementById('echart-pareto-analysis');
              if (chartDom5) {
                  var myChart5 = echarts.init(chartDom5);
                  myChart5.setOption(option_pareto);
              }
              {% endif %}
          });
        </script>
        {% endif %}
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 테이블 정렬 기능 - 완전히 새로 작성
      document.addEventListener("DOMContentLoaded", function () {
        console.log("=== 정렬 시스템 초기화 ===");

        const table = document.getElementById("alertTable");
        if (!table) {
          console.log("❌ 테이블을 찾을 수 없습니다");
          return;
        }

        console.log("✅ 테이블 발견");

        // 테이블 헤더에 클릭 이벤트 추가
        const headers = table.querySelectorAll("th.sortable-header");
        console.log("정렬 가능한 헤더 개수:", headers.length);

        headers.forEach((header) => {
          header.style.cursor = "pointer";
          header.addEventListener("click", function (e) {
            console.log("🔥 헤더 클릭됨:", this.getAttribute("data-sort"));

            const column = this.getAttribute("data-sort");
            const currentDirection =
              this.getAttribute("data-direction") || "asc";
            const newDirection = currentDirection === "asc" ? "desc" : "asc";

            console.log("정렬 컬럼:", column, "방향:", newDirection);

            // 모든 헤더의 방향 초기화
            headers.forEach((h) => {
              h.setAttribute("data-direction", "");
              h.style.backgroundColor = "";
            });

            // 현재 헤더에 방향 설정
            this.setAttribute("data-direction", newDirection);
            this.style.backgroundColor = "#f3f4f6";

            // 테이블 정렬 실행
            sortTable(table, column, newDirection);
          });
        });

        function sortTable(table, column, direction) {
          console.log("🔄 정렬 시작:", column, direction);

          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));

          console.log("정렬할 행 개수:", rows.length);

          rows.sort((a, b) => {
            const aCell = a.querySelector(`td[data-sort="${column}"]`);
            const bCell = b.querySelector(`td[data-sort="${column}"]`);

            if (!aCell || !bCell) {
              console.log("셀을 찾을 수 없음:", column);
              return 0;
            }

            let aValue = aCell.getAttribute("data-sort-value") || "";
            let bValue = bCell.getAttribute("data-sort-value") || "";

            console.log("비교 값:", aValue, "vs", bValue);

            // 발주제안 컬럼은 숫자로 처리
            if (column === "order") {
              aValue = parseInt(aValue) || 0;
              bValue = parseInt(bValue) || 0;
              return direction === "asc" ? aValue - bValue : bValue - aValue;
            }

            // 숫자 정렬
            if (
              !isNaN(aValue) &&
              !isNaN(bValue) &&
              aValue !== "" &&
              bValue !== ""
            ) {
              return direction === "asc"
                ? parseFloat(aValue) - parseFloat(bValue)
                : parseFloat(bValue) - parseFloat(aValue);
            }

            // 날짜 정렬
            const aDate = new Date(aValue);
            const bDate = new Date(bValue);
            if (!isNaN(aDate) && !isNaN(bDate)) {
              return direction === "asc" ? aDate - bDate : bDate - aDate;
            }

            // 문자열 정렬
            return direction === "asc"
              ? aValue.localeCompare(bValue)
              : bValue.localeCompare(aValue);
          });

          // 정렬된 행을 테이블에 다시 추가
          rows.forEach((row) => tbody.appendChild(row));
          console.log("✅ 정렬 완료");
        }
      });
      // 키보드 네비게이션 기능
      function setupKeyboardNavigation() {
        // 현재 선택된 상품이 있는지 확인
        const currentProduct = "{{ selected_product }}";
        const currentColor = "{{ selected_color }}";
        if (!currentProduct) {
          return; // 상품이 선택되지 않았으면 키보드 네비게이션 비활성화
        }

        // 현재 활성 탭 확인
        let currentTab = 'product';
        const productTab = document.getElementById('product-tab');
        const colorTab = document.getElementById('color-tab');
        if (productTab && colorTab) {
          if (productTab.classList.contains('bg-blue-100')) {
            currentTab = 'product';
          } else if (colorTab.classList.contains('bg-blue-100')) {
            currentTab = 'color';
          }
        }

        // 현재 탭에 따른 링크 목록 가져오기
        let navigationLinks = [];
        if (currentTab === 'product') {
          // 상품별 탭: 상품 링크만 가져오기
          const productLinks = document.querySelectorAll('#product-list a[href*="product="]');
          navigationLinks = Array.from(productLinks).map((link) => {
          const url = new URL(link.href);
            return {
              product: url.searchParams.get("product"),
              color: url.searchParams.get("color") || ""
            };
          });
        } else {
          // 컬러별 탭: 컬러 링크만 가져오기
          const colorLinks = document.querySelectorAll('#color-list a[href*="product="]');
          navigationLinks = Array.from(colorLinks).map((link) => {
            const url = new URL(link.href);
            return {
              product: url.searchParams.get("product"),
              color: url.searchParams.get("color") || ""
            };
          });
        }

        if (navigationLinks.length <= 1) {
          return; // 항목이 1개 이하면 네비게이션 불필요
        }

        // 현재 항목의 인덱스 찾기
        const currentIndex = navigationLinks.findIndex(item => {
          if (currentTab === 'product') {
            // 상품별 탭에서는 상품명만 비교 (color는 빈 문자열)
            return item.product === currentProduct && item.color === "";
          } else {
            // 컬러별 탭에서는 상품명과 컬러 모두 비교
            return item.product === currentProduct && item.color === currentColor;
          }
        });
        if (currentIndex === -1) {
          return;
        }

        // 키보드 이벤트 리스너 추가
        document.addEventListener("keydown", function (e) {
          // 입력 필드에 포커스가 있으면 키보드 네비게이션 비활성화
          if (
            e.target.tagName === "INPUT" ||
            e.target.tagName === "TEXTAREA" ||
            e.target.tagName === "SELECT"
          ) {
            return;
          }

          let nextIndex = -1;

          if (e.key === "ArrowLeft") {
            // 왼쪽 화살표: 이전 항목
            nextIndex =
              currentIndex > 0 ? currentIndex - 1 : navigationLinks.length - 1;
            e.preventDefault();
          } else if (e.key === "ArrowRight") {
            // 오른쪽 화살표: 다음 항목
            nextIndex =
              currentIndex < navigationLinks.length - 1 ? currentIndex + 1 : 0;
            e.preventDefault();
          }

          if (nextIndex !== -1 && nextIndex !== currentIndex) {
            const nextItem = navigationLinks[nextIndex];
            let url = `/dashboard?product=${encodeURIComponent(nextItem.product)}`;
            if (nextItem.color) {
              let colorName = nextItem.color;
              if (colorName.includes(' - ')) {
                colorName = colorName.split(' - ').pop().trim();
              }
              url += `&color=${encodeURIComponent(colorName)}`;
            }
            window.location.href = url;
          }
        });

        // 키보드 단축키 안내 표시
        const header = document.querySelector("header");
        if (header) {
          // 기존 키보드 안내 제거
          const existingInfo = header.querySelector('.text-xs.text-gray-400');
          if (existingInfo) {
            existingInfo.remove();
          }
          
          const keyboardInfo = document.createElement("div");
          keyboardInfo.className = "text-xs text-gray-400 mt-1";
          keyboardInfo.innerHTML =
            `<i class="fas fa-keyboard mr-1"></i>← → 키로 ${currentTab === 'product' ? '상품' : '컬러'} 이동`;
          header
            .querySelector(".flex.items-center.space-x-4")
            .appendChild(keyboardInfo);
        }
      }

      // 페이지 로드 시 키보드 네비게이션 설정
      document.addEventListener("DOMContentLoaded", function () {
        setupKeyboardNavigation();
      });
    </script>
  </body>
</html>
